<%-include('../../adminlayout/partials/header')%>
  <body>
    <div class="container-scroller">

      <%-include('../../adminlayout/partials/navbar') %>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
       <%-include('../../adminlayout/partials/topbar') %>



       <div class="main-panel">
        <div class="content-wrapper">
            <div class="row ">
              <div class="col-12 grid-margin">
                <div class="card">
                  <div class="card-body">
                    <h4 class="card-title">All Pending Withdrawals </h4>
                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>
                              <!-- <div class="form-check form-check-muted m-0">
                                <label class="form-check-label">
                                  <input type="checkbox" class="form-check-input">
                                <i class="input-helper"></i></label>
                              </div> -->
                            </th>
                            <th> Transaction ID </th>
                            <th> User Name </th>
                            <th> Withdrawal Amount </th>
                            <th> Method of Payment </th>
                            <th> Payment Status </th>
                            <th> Date of Withdrawal </th>
                            <th colspan="3"> Operations </th>
                            <!-- <th> Decline </th>
                            <th> Delete </th> -->
                            <!-- <th> Payment Status </th> -->
                             
                          </tr>
                        </thead>
                        <tbody>
                          <% if (Array.isArray(withdrawals) && withdrawals.length) { %>
                            <% withdrawals.forEach(function(w) { %>
                              <tr>
                                <td>
                                </td>
                                <td style="color: rgb(146, 88, 88);"><%= w.withdrawaltransactionid.slice(0, 12) || '—' %></td>
                                <td><%= w.username || '—' %></td>
                                <td><%= w.amount || '—' %></td>
                                <td><%= w.withdrawalmethod || '—' %></td>
                                <td><%= w.withdrawalstatus || '—' %></td>
                                <td><%= (w.created_at || w.createdAt).toLocaleDateString() || '—' %></td>
                                <td>
                                    <form class="approve-deposit-form" data-transaction="<%= w.withdrawaltransactionid %>">
                                        <input type="hidden" name="id" value="<%= w.id %>">
                                        <input type="hidden" name="withdrawid" value="<%= w.withdrawaltransactionid %>">
                                        <input type="hidden" name="username" value="<%= w.username %>">
                                        <input type="hidden" name="amount" value="<%= w.amount %>">
                                        <button type="submit" class="btn btn-inverse-success btn-fw">Approve</button>
                                    </form>
                                </td>
                                <td>
                                   <form action="/admin/withdraw/decline" method="post" class="decline-deposit-form">
                                        <input type="hidden" name="id" value="<%= w.id %>">
                                        <input type="hidden" name="withdrawid" value="<%= w.withdrawaltransactionid %>">
                                        <input type="hidden" name="username" value="<%= w.username %>">
                                        <input type="hidden" name="amount" value="<%= w.amount %>">
                                        <button type="submit" class="btn btn-inverse-warning btn-fw">Decline</button>
                                    </form>
                                </td>
                                <td>
                                    <form action="/admin/withdraw/delete" method="post" class="delete-deposit-form">
                                        <input type="hidden" name="id" value="<%= w.id %>">
                                        <input type="hidden" name="withdrawid" value="<%= w.withdrawaltransactionid %>">
                                        <input type="hidden" name="username" value="<%= w.username %>">
                                        <input type="hidden" name="amount" value="<%= w.amount %>">
                                        <button type="submit" class="btn btn-inverse-danger btn-fw">Delete</button>
                                    </form>
                                </td>
                              </tr>
                            <% }) %>
                          <% } else { %>
                            <tr>
                              <td colspan="7" class="text-center">No pending withdrawals found</td>
                            </tr>
                          <% } %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

              </div>
            </div>
        </div>
       </div>
        <% if (error) { %>
                <div class="alert alert-danger"><%= error %></div>
                <% } %> <% if (errors && errors.length) { %>
                <div class="alert alert-danger">
                  <ul>
                    <% errors.forEach(function(e){ %>
                    <li><%= e %></li>
                    <% }) %>
                  </ul>
                </div>
                <% } %> <% if (success) { %>
                <div class="alert alert-success">
                  Deposit Successfully Declined
                </div>
                <% } %>

       
       

      

       

<div id="admin-flash" style="position:fixed;right:20px;bottom:20px;z-index:9999;display:none;">
  <div id="admin-flash-msg" class="alert alert-success" role="alert"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  function showFlash(message, type='success', timeout=4000){
    const container = document.getElementById('admin-flash');
    const msg = document.getElementById('admin-flash-msg');
    msg.textContent = message;
    msg.className = 'alert alert-' + (type === 'success' ? 'success' : 'danger');
    container.style.display = 'block';
    setTimeout(()=>{ container.style.display = 'none'; }, timeout);
  }

  document.querySelectorAll('.approve-deposit-form').forEach(form => {
    form.addEventListener('submit', async function(ev){
      ev.preventDefault();
      const fd = new FormData(form);
      const payload = {};
      for (const [k,v] of fd.entries()) payload[k]=v;
      try {
        const res = await fetch('/admin/withdraw/approve', { method: 'POST', headers: { 'Accept': 'application/json' }, body: new URLSearchParams(payload) });
        if (res.ok) {
          const body = await res.json().catch(()=>({}));
          // treat 200/201 as success; prefer 201 if server uses it
          showFlash(body.message || 'Withdrawal approved', 'success');
          // update the row status cell visually
          const tr = form.closest('tr');
          window.location.reload();
          if (tr) {
            const statusCell = tr.querySelectorAll('td')[5];
            if (statusCell) statusCell.textContent = 'approved';
            // disable the approve button
            form.querySelector('button[type="submit"]').disabled = true;
          }
        } else {
          const err = await res.json().catch(()=>({}));
          showFlash(err.message || 'Failed to approve deposit', 'error');
        }
      } catch (e){
        console.error('Approve request failed', e);
        showFlash('Network error while approving', 'error');
      }
    });
  });
});
</script>

 <%-include('../../adminlayout/partials/footer') %>